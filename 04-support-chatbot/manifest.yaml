name: support-chatbot
version: "2.0.0"
description: "Multi-step customer support chatbot with intelligent routing and escalation"

graphs:
  - name: support_conversation
    entry_node: classify_intent
    nodes:
      - id: classify_intent
        kind: router
        label: "Intent Classifier"
        router_ref: intent_classifier
      
      - id: search_knowledge
        kind: tool
        label: "Knowledge Base Search"
        tool_ref: knowledge_search
      
      - id: troubleshoot
        kind: task
        label: "Technical Troubleshooting"
        config:
          model: "local://qwen3"
          prompt: |
            Help troubleshoot this technical issue:
            {user_message}
            
            Previous context: {conversation_history}
            
            Provide step-by-step guidance or ask clarifying questions.
      
      - id: account_lookup
        kind: tool
        label: "Account Lookup"
        tool_ref: account_service
      
      - id: handle_billing
        kind: task
        label: "Billing Handler"
        config:
          model: "local://qwen3"
          prompt: |
            Handle this billing inquiry:
            {user_message}
            
            Account info: {account_info}
      
      - id: sentiment_check
        kind: router
        label: "Sentiment & Urgency Analysis"
        router_ref: sentiment_router
      
      - id: escalate_human
        kind: task
        label: "Escalate to Human"
        config:
          action: "create_ticket"
          priority: "high"
          queue: "support_queue"
      
      - id: generate_response
        kind: router
        label: "Generate Response"
        router_ref: response_generator
    
    edges:
      - from_node: classify_intent
        to_node: search_knowledge
        condition:
          trigger: success
          route: "faq"
      
      - from_node: classify_intent
        to_node: troubleshoot
        condition:
          trigger: success
          route: "technical"
      
      - from_node: classify_intent
        to_node: account_lookup
        condition:
          trigger: success
          route: "billing"
      
      - from_node: classify_intent
        to_node: sentiment_check
        condition:
          trigger: success
          route: "complaint"
      
      - from_node: classify_intent
        to_node: generate_response
        condition:
          trigger: success
          route: "other"
      
      - from_node: search_knowledge
        to_node: generate_response
        condition:
          trigger: success
      
      - from_node: troubleshoot
        to_node: generate_response
        condition:
          trigger: success
      
      - from_node: account_lookup
        to_node: handle_billing
        condition:
          trigger: success
      
      - from_node: handle_billing
        to_node: generate_response
        condition:
          trigger: success
      
      - from_node: sentiment_check
        to_node: escalate_human
        condition:
          route: "escalate"
      
      - from_node: sentiment_check
        to_node: generate_response
        condition:
          route: "handle"

routers:
  - name: intent_classifier
    strategy: llm
    system_message: |
      You are an intent classifier for customer support.
      
      Analyze the user's message and classify their intent into ONE of these categories:
      - "faq" - General questions about products/services
      - "technical" - Technical issues, bugs, errors, troubleshooting
      - "billing" - Payment, invoices, subscriptions, account billing
      - "complaint" - Negative feedback, frustration, dissatisfaction
      - "other" - Anything else that doesn't fit the above categories
      
      Respond with ONE word only: faq, technical, billing, complaint, or other.
      No explanations, no JSON, just the category word.
    default_model: "ollama://qwen3:8b"
  
  - name: sentiment_router
    strategy: llm
    system_message: |
      You analyze customer complaints for sentiment and urgency.
      
      Analyze the complaint and determine if it needs immediate escalation or can be handled automatically.
      
      Respond with ONE word:
      - "escalate" - If sentiment is very negative (frustrated, angry) OR urgency is high
      - "handle" - If sentiment is neutral/positive OR urgency is low/medium
      
      Respond with ONLY the word: escalate or handle.
      No explanations, no JSON, just the word.
    default_model: "ollama://qwen3:8b"
  
  - name: response_generator
    strategy: llm
    system_message: |
      You are a helpful customer support assistant.
      
      Generate a helpful, empathetic response to the customer's inquiry.
      Be concise, professional, and offer clear next steps.
      
      Use the context from previous steps (intent classification, troubleshooting, knowledge base results, etc.)
      to provide a relevant and helpful response.
      
      Respond naturally as if you're a human support agent.
    default_model: "ollama://qwen3:8b"

tools:
  - name: knowledge_search
    description: "Search knowledge base for relevant articles"
    protocol: "http"
    config:
      endpoint: "https://api.example.com/kb/search"
      method: "POST"
    input_schema:
      type: object
      properties:
        query:
          type: string
        limit:
          type: integer
          default: 5
    output_schema:
      type: object
      properties:
        articles:
          type: array

  - name: account_service
    description: "Look up customer account information"
    protocol: "http"
    config:
      endpoint: "https://api.example.com/accounts/lookup"
      method: "GET"
    input_schema:
      type: object
      properties:
        user_id:
          type: string
    output_schema:
      type: object
      properties:
        account_id:
          type: string
        plan:
          type: string
        status:
          type: string

policies:
  - name: escalation_policy
    description: "Rules for escalating to human agents"
    rules:
      - name: frustrated_user
        condition: "sentiment_score < 0.3"
        action: "escalate_immediately"
      - name: long_conversation
        condition: "turn_count > 5 and not resolved"
        action: "offer_human_agent"

